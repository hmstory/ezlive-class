<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ezlive - P2P í™”ìƒ ê°•ì˜</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS CDN -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        /* ê¸°ë³¸ í°íŠ¸ ì„¤ì • */
        body {
            font-family: "Inter", "Pretendard", sans-serif;
        }
        /* ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ ìŠ¤íƒ€ì¼ (ë°”ë‘‘íŒì‹) */
        #video-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }
        /* ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ ìŠ¤íƒ€ì¼ (1:1 ë¹„ìœ¨) */
        .video-container {
            position: relative;
            width: 100%;
            padding-bottom: 100%; /* 1:1 Aspect Ratio */
            border-radius: 0.5rem;
            overflow: hidden;
            background-color: #2d3748;
        }
        .video-container video {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .video-container .video-label {
            position: absolute;
            bottom: 8px;
            left: 8px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 0.875rem;
        }
        /* ì±„íŒ… ë§í’ì„  */
        .chat-bubble {
            max-width: 70%;
            padding: 8px 12px;
            border-radius: 1rem;
        }
        .chat-bubble.me {
            background-color: #3b82f6;
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 0.25rem;
        }
        .chat-bubble.peer {
            background-color: #e5e7eb;
            color: #1f2937;
            align-self: flex-start;
            border-bottom-left-radius: 0.25rem;
        }
        /* í˜ì´ì§€ ì „í™˜ì„ ìœ„í•œ ìˆ¨ê¹€ ì²˜ë¦¬ */
        .page {
            display: none;
        }
        .page.active {
            display: block;
        }
        /* ì „ì²´í™”ë©´ ì‹œ ì¸ë„¤ì¼ */
        #thumbnail-videos {
            position: fixed;
            top: 20px;
            left: 20px;
            width: 150px;
            z-index: 1001; /* ì „ì²´í™”ë©´ ë¹„ë””ì˜¤ë³´ë‹¤ ìœ„ì— */
            display: none; /* í‰ì†Œì—” ìˆ¨ê¹€ */
        }
        #thumbnail-videos .video-container {
            padding-bottom: 100%; /* 1:1 */
            margin-bottom: 8px;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ê²½ê³  ë©”ì‹œì§€ (ë¹„-ë³´ì•ˆ í™˜ê²½) -->
    <div id="security-warning" class="hidden p-4 bg-red-600 text-white font-bold text-center">
        ê²½ê³ : ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ëŠ” 'https://' ë˜ëŠ” 'localhost' í™˜ê²½ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤. í˜„ì¬ ë³´ì•ˆë˜ì§€ ì•Šì€ í™˜ê²½ì—ì„œ ì ‘ì† ì¤‘ì…ë‹ˆë‹¤.
    </div>

    <!-- ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€ ë° ìƒˆ ì°½ ì—´ê¸° í”„ë¡¬í”„íŠ¸ -->
    <div id="inapp-browser-warning" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-white p-6 rounded-lg shadow-lg text-center">
            <h2 class="text-xl font-bold mb-4">ì•Œë¦¼</h2>
            <p>ì›í™œí•œ ì„œë¹„ìŠ¤ ì´ìš©ì„ ìœ„í•´<br>ì™¸ë¶€ ë¸Œë¼ìš°ì €(Chrome, Safari ë“±)ì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.</p>
            <button id="open-external-btn" class="mt-4 bg-blue-500 text-white px-4 py-2 rounded-lg">ì™¸ë¶€ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°</button>
        </div>
    </div>

    <!-- í˜ì´ì§€: í™ˆ -->
    <div id="page-home" class="page active min-h-screen flex items-center justify-center">
        <div class="text-center p-8 bg-white rounded-lg shadow-xl">
            <h1 class="text-4xl font-bold mb-8 text-blue-600">ezlive</h1>
            <div class="space-y-4">
                <button onclick="navigate('create')" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 transition">
                    êµì‚¬ìš© í™”ìƒê°•ì˜ ìƒì„±
                </button>
                <button onclick="navigate('join')" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition">
                    í•™ìƒìš© ê°•ì˜ ì°¸ì—¬
                </button>
            </div>
        </div>
    </div>

    <!-- í˜ì´ì§€: êµì‚¬ìš© ê°•ì˜ ìƒì„± -->
    <div id="page-create" class="page min-h-screen flex items-center justify-center bg-gray-50">
        <div class="p-8 bg-white rounded-lg shadow-xl w-full max-w-md">
            <button onclick="navigate('home')" class="text-gray-500 hover:text-gray-700">&larr; ë’¤ë¡œê°€ê¸°</button>
            <h2 class="text-2xl font-bold text-center my-4">êµì‚¬ìš© ê°•ì˜ ìƒì„±</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">êµì‚¬ ì¸ì¦ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="teacher-pass" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="êµì‚¬ ì „ìš© ë¹„ë°€ë²ˆí˜¸ (a123456!)">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ê°•ì˜ì‹¤ ì´ë¦„ (ê³µìœ ìš©)</label>
                    <input type="text" id="room-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="ì˜ˆ: 3í•™ë…„ 1ë°˜ ìˆ˜í•™">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">í•™ìƒ ì ‘ì† ë¹„ë°€ë²ˆí˜¸ (ì„¤ì •)</label>
                    <input type="text" id="room-pass" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="í•™ìƒë“¤ì´ ì…ë ¥í•  ë¹„ë°€ë²ˆí˜¸">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">
                        í•™ìƒ ê³„ì • ì„¤ì • (í•œ ì¤„ì— í•œ ëª…)
                        <span class="text-xs text-gray-500">(í˜•ì‹: ì•„ì´ë””,ë¹„ë°€ë²ˆí˜¸)</span>
                    </label>
                    <textarea id="student-list" rows="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="student1,pass1&#10;student2,pass2&#10;john,john123"></textarea>
                </div>
                <button id="create-room-btn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 transition">
                    ê°•ì˜ ìƒì„± ë° ì‹œì‘
                </button>
                <div id="create-error" class="text-red-500 text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- í˜ì´ì§€: í•™ìƒìš© ê°•ì˜ ì°¸ì—¬ -->
    <div id="page-join" class="page min-h-screen flex items-center justify-center bg-gray-50">
        <div class="p-8 bg-white rounded-lg shadow-xl w-full max-w-md">
            <button onclick="navigate('home')" class="text-gray-500 hover:text-gray-700">&larr; ë’¤ë¡œê°€ê¸°</button>
            <h2 class="text-2xl font-bold text-center my-4">í•™ìƒìš© ê°•ì˜ ì°¸ì—¬</h2>
            <div class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700">ê°•ì˜ì‹¤ ì´ë¦„ (ID)</label>
                    <input type="text" id="join-room-id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="êµì‚¬ì—ê²Œ ë°›ì€ ê°•ì˜ì‹¤ ì´ë¦„">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ê°•ì˜ì‹¤ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="join-room-pass" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="êµì‚¬ì—ê²Œ ë°›ì€ ê°•ì˜ì‹¤ ë¹„ë°€ë²ˆí˜¸">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ë‚´ ì•„ì´ë””</label>
                    <input type="text" id="join-student-id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="êµì‚¬ì—ê²Œ ë“±ë¡ëœ ë‚´ ì•„ì´ë””">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700">ë‚´ ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="join-student-pass" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="êµì‚¬ì—ê²Œ ë“±ë¡ëœ ë‚´ ë¹„ë°€ë²ˆí˜¸">
                </div>
                <button id="join-room-btn" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition">
                    ê°•ì˜ ì°¸ì—¬í•˜ê¸°
                </button>
                <div id="join-error" class="text-red-500 text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- í˜ì´ì§€: ê°•ì˜ì‹¤ -->
    <div id="page-room" class="page h-screen flex flex-col md:flex-row bg-gray-900 text-white">
        <!-- ë©”ì¸ ì»¨í…ì¸  (ë¹„ë””ì˜¤ + ì±„íŒ…) -->
        <div class="flex-1 flex flex-col h-full overflow-hidden relative">
            
            <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ ë°” -->
            <div class="absolute top-0 left-0 p-2 space-x-2 z-10 bg-gray-900 bg-opacity-50 rounded-br-lg">
                <button id="toggle-video-btn" title="ë¹„ë””ì˜¤" class="bg-blue-500 p-2 rounded-full hover:bg-blue-600">ğŸ¥</button>
                <button id="toggle-audio-btn" title="ì˜¤ë””ì˜¤" class="bg-blue-500 p-2 rounded-full hover:bg-blue-600">ğŸ¤</button>
                <button id="share-screen-btn" title="í™”ë©´ ê³µìœ " class="bg-green-500 p-2 rounded-full hover:bg-green-600">ğŸ–¥ï¸</button>
                <button id="whiteboard-btn" title="íŒì„œë„êµ¬ (ë¯¸êµ¬í˜„)" class="bg-yellow-500 p-2 rounded-full hover:bg-yellow-600" onclick="alert('íŒì„œë„êµ¬ ê¸°ëŠ¥ì€ í˜„ì¬ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')">ğŸ¨</button>
                <button id="export-chat-btn" title="ì±„íŒ… ì €ì¥ (CSV)" class="bg-gray-500 p-2 rounded-full hover:bg-gray-600">ğŸ’¾</button>
                <button id="end-call-btn" title="ì¢…ë£Œ" class="bg-red-500 p-2 rounded-full hover:bg-red-600">ğŸšª</button>
            </div>

            <!-- ê°•ì˜ì‹¤ ì •ë³´ (êµì‚¬ìš©) -->
            <div id="room-info" class="hidden absolute top-0 right-0 p-3 bg-gray-800 text-sm rounded-bl-lg z-10">
                <h3 class="font-bold">ê°•ì˜ì‹¤ ì •ë³´</h3>
                <p>ID: <strong id="info-room-id" class="text-yellow-300"></strong></p>
                <p>PW: <strong id="info-room-pass" class="text-yellow-300"></strong></p>
                <button onclick="copyRoomInfo()" class="mt-1 text-xs bg-blue-500 px-2 py-1 rounded">ì •ë³´ ë³µì‚¬</button>
            </div>

            <!-- ì „ì²´í™”ë©´ ì¸ë„¤ì¼ (ìˆ¨ê²¨ì§) -->
            <div id="thumbnail-videos" class="space-y-2"></div>

            <!-- ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ -->
            <div id="video-grid" class="flex-1 p-4 pt-16 overflow-y-auto">
                <!-- ë‚´ ë¹„ë””ì˜¤ -->
                <div id="my-video-container" class="video-container relative group">
                    <video id="my-video" muted playsinline></video>
                    <div class="video-label">ë‚˜</div>
                    <div class="absolute top-2 right-2 space-x-1 opacity-0 group-hover:opacity-100 transition-opacity z-20">
                        <button onclick="togglePiP('my-video')" class="bg-black bg-opacity-50 p-1 rounded text-xs">PiP</button>
                        <button onclick="toggleVideoFullscreen('my-video-container')" class="bg-black bg-opacity-50 p-1 rounded text-xs">â›¶</button>
                    </div>
                </div>
                <!-- í”¼ì–´ ë¹„ë””ì˜¤ëŠ” ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
            </div>

            <!-- ì±„íŒ…ì°½ (ëª¨ë°”ì¼ì—ì„œëŠ” í•˜ë‹¨, ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ë¶„ë¦¬) -->
            <div id="chat-wrapper" class="h-1/3 md:h-full md:w-80 bg-gray-800 flex flex-col flex-shrink-0 transition-all">
                <h3 class="text-lg font-semibold p-3 border-b border-gray-700">ì±„íŒ…</h3>
                
                <!-- ì±„íŒ… ë©”ì‹œì§€ ëª©ë¡ -->
                <div id="chat-messages" class="flex-1 p-3 space-y-2 overflow-y-auto flex flex-col">
                    <!-- ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤ -->
                </div>

                <!-- ì±„íŒ… ì…ë ¥ -->
                <div class="p-3 border-t border-gray-700">
                    <form id="chat-form" class="flex space-x-2">
                        <input id="chat-input" type="text" class="flex-1 bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off">
                        <button type="submit" class="bg-blue-600 px-4 py-2 rounded-lg font-semibold">ì „ì†¡</button>
                    </form>
                    <!-- íŒŒì¼ ì…ë ¥ (ë¯¸êµ¬í˜„) -->
                    <label class="mt-2 text-xs text-gray-400 hover:text-white cursor-pointer">
                        <input type="file" id="file-input" class="hidden" onchange="alert('íŒŒì¼ ì „ì†¡ ê¸°ëŠ¥ì€ í˜„ì¬ êµ¬í˜„ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.')">
                        ğŸ“ íŒŒì¼ ì²¨ë¶€ (ë¯¸êµ¬í˜„)
                    </label>
                </div>
            </div>

            <!-- ì±„íŒ… ì „ì²´í™”ë©´ ë³´ê¸° (ìˆ¨ê²¨ì§) -->
            <div id="full-chat-view" class="hidden absolute inset-0 bg-gray-800 z-30 flex flex-col">
                <div class="p-3 border-b border-gray-700 flex justify-between items-center">
                    <h3 class="text-lg font-semibold">ì±„íŒ… (ì „ì²´ë³´ê¸°)</h3>
                    <button id="close-full-chat-btn" class="bg-gray-600 px-3 py-1 rounded-lg">ëŒì•„ê°€ê¸°</button>
                </div>
                <div id="full-chat-messages" class="flex-1 p-3 space-y-2 overflow-y-auto flex flex-col">
                    <!-- ë©”ì‹œì§€ ë³µì œë³¸ -->
                </div>
                <div class="p-3 border-t border-gray-700">
                    <!-- ì±„íŒ… ì…ë ¥ í¼ (ì´ë²¤íŠ¸ ìœ„ì„) -->
                    <form id="chat-form-full" class="flex space-x-2">
                        <input id="chat-input-full" type="text" class="flex-1 bg-gray-700 text-white rounded-lg px-4 py-2 focus:outline-none" placeholder="ë©”ì‹œì§€ ì…ë ¥..." autocomplete="off">
                        <button type="submit" class="bg-blue-600 px-4 py-2 rounded-lg font-semibold">ì „ì†¡</button>
                    </form>
                </div>
            </div>

            <!-- ëª¨ë°”ì¼ìš© ì±„íŒ… í† ê¸€ ë²„íŠ¼ -->
            <button id="toggle-chat-new-window" class="md:hidden fixed bottom-4 right-4 bg-blue-600 text-white p-3 rounded-full shadow-lg z-20">
                ğŸ’¬
            </button>
        </div>
    </div>

    <script>
        // --- ê²½ê³  ë° í™˜ê²½ì„¤ì • ---

        // 1. HTTPS/Localhost ì•„ë‹ˆë©´ ê²½ê³ 
        if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
            document.getElementById('security-warning').classList.remove('hidden');
        }

        // 2. ì¸ì•± ë¸Œë¼ìš°ì € ê°ì§€ (ì¹´ì¹´ì˜¤í†¡ ë“±)
        (function() {
            const userAgent = navigator.userAgent.toLowerCase();
            const inAppMatchers = /kakaotalk|naver|line|fb_iab|wv|webview/i;
            if (inAppMatchers.test(userAgent)) {
                document.getElementById('inapp-browser-warning').classList.remove('hidden');
                
                // ì™¸ë¶€ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸° (Android/iOS í˜¸í™˜)
                document.getElementById('open-external-btn').onclick = function() {
                    try {
                        // iOS 9+ Universal Links or Android Intent
                        const url = window.location.href;
                        const a = document.createElement('a');
                        a.href = `intent:${url.replace(/https?:\/\//, '')}#Intent;scheme=${window.location.protocol.slice(0, -1)};package=com.android.chrome;end`;
                        
                        if (navigator.userAgent.match(/android/i)) {
                            document.location.href = a.href;
                        } else if (navigator.userAgent.match(/iphone|ipad|ipod/i)) {
                            // iOSëŠ” intentë¥¼ ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì‚¬ìš©ìì—ê²Œ ì§ì ‘ ë³µì‚¬/ë¶™ì—¬ë„£ê¸°ë¥¼ ì•ˆë‚´í•˜ëŠ” ê²ƒì´ ë” ë‚˜ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                            // ì—¬ê¸°ì„œëŠ” ë‹¨ìˆœí™”ëœ íŒì—…ì„ ìœ ì§€í•©ë‹ˆë‹¤.
                            alert("ë¸Œë¼ìš°ì € í•˜ë‹¨ì˜ '...' ë˜ëŠ” 'ê³µìœ ' ë²„íŠ¼ì„ ëˆŒëŸ¬ 'ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¡œ ì—´ê¸°'ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
                        }
                    } catch (e) {
                        alert("ìë™ ì „í™˜ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. URLì„ ë³µì‚¬í•˜ì—¬ Chromeì´ë‚˜ Safariì—ì„œ ì—´ì–´ì£¼ì„¸ìš”.");
                    }
                };
            }
        })();


        // --- ê¸€ë¡œë²Œ ìƒíƒœ ë³€ìˆ˜ ---
        let peer;
        let myStream;
        let isHost = false;
        let studentCredentials = new Map(); // [id, pass]
        let roomPassword = "";
        let myRoomId = "";
        let currentScreenStream;
        let isScreenSharing = false;
        
        // ì—°ê²°ëœ í”¼ì–´ ê´€ë¦¬ (DataConnection, MediaConnection)
        // key: peerId, value: { conn, call, videoEl, username }
        const peers = {};
        const chatHistory = [];

        // --- DOM ìš”ì†Œ ---
        const pages = {
            home: document.getElementById('page-home'),
            create: document.getElementById('page-create'),
            join: document.getElementById('page-join'),
            room: document.getElementById('page-room'),
        };
        const createRoomBtn = document.getElementById('create-room-btn');
        const joinRoomBtn = document.getElementById('join-room-btn');
        const myVideo = document.getElementById('my-video');
        const videoGrid = document.getElementById('video-grid');
        const thumbnailVideos = document.getElementById('thumbnail-videos');

        const chatForm = document.getElementById('chat-form');
        const chatInput = document.getElementById('chat-input');
        const chatMessages = document.getElementById('chat-messages');

        // ì±„íŒ… ìƒˆ ì°½ ê´€ë ¨
        const toggleChatNewWindowBtn = document.getElementById('toggle-chat-new-window');
        const chatWrapper = document.getElementById('chat-wrapper');
        const fullChatView = document.getElementById('full-chat-view');
        const fullChatMessages = document.getElementById('full-chat-messages');
        const closeFullChatBtn = document.getElementById('close-full-chat-btn');
        const chatFormFull = document.getElementById('chat-form-full');
        const chatInputFull = document.getElementById('chat-input-full');
        
        // ì»¨íŠ¸ë¡¤ ë²„íŠ¼
        const toggleVideoBtn = document.getElementById('toggle-video-btn');
        const toggleAudioBtn = document.getElementById('toggle-audio-btn');
        const shareScreenBtn = document.getElementById('share-screen-btn');
        const exportChatBtn = document.getElementById('export-chat-btn');
        const endCallBtn = document.getElementById('end-call-btn');


        // --- ë„¤ë¹„ê²Œì´ì…˜ ---
        function navigate(pageName) {
            Object.values(pages).forEach(page => page.classList.remove('active'));
            if (pages[pageName]) {
                pages[pageName].classList.add('active');
            }
            // ë°© í˜ì´ì§€ë¡œ ì´ë™ ì‹œ, URL í•´ì‹œ ë³€ê²½ (ìƒˆë¡œê³ ì¹¨ ë°©ì§€ìš©)
            if (pageName === 'room') {
                window.location.hash = myRoomId || 'room';
            } else if (pageName === 'home') {
                window.location.hash = '';
            }
        }

        // --- í•µì‹¬ ë¡œì§ (ë¯¸ë””ì–´ ë° Peer) ---

        /**
         * 1. ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ê°€ì ¸ì˜¤ê¸° (ì¹´ë©”ë¼, ë§ˆì´í¬)
         */
        async function getMediaStream() {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({
                    video: true,
                    audio: true
                });
                myVideo.srcObject = myStream;
                await myVideo.play();
            } catch (err) {
                console.error("Failed to get media stream", err);
                alert("ì¹´ë©”ë¼ ë˜ëŠ” ë§ˆì´í¬ ì ‘ê·¼ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                // HTTPS/Localhostê°€ ì•„ë‹ˆë©´ ì—¬ê¸°ì„œ ì‹¤íŒ¨í•  ê°€ëŠ¥ì„± ë†’ìŒ
            }
        }

        /**
         * 3. (í•™ìƒ) í˜¸ìŠ¤íŠ¸(êµì‚¬)ì—ê²Œ ì—°ê²°
         */
        async function connectToHost(roomId, roomPass, studentId, studentPass) {
            console.log(`Connecting to host: ${roomId}`);
            
            // 3.1. ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ ë¨¼ì € ì¤€ë¹„
            await getMediaStream();
            if (!myStream) {
                document.getElementById('join-error').innerText = "ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.";
                navigate('join');
                return;
            }

            // 3.2. ì¸ì¦ ì •ë³´ë¥¼ Metadataë¡œ í•¨ê»˜ ì „ì†¡
            const conn = peer.connect(roomId, {
                metadata: {
                    username: studentId,
                    studentPass: studentPass,
                    roomPass: roomPass
                }
            });

            peers[roomId] = { conn: conn, call: null, username: 'êµì‚¬', videoEl: null };
            setupDataConnection(conn);
        }
        
        /**
         * 4. ë°ì´í„° ì±„ë„ ì—°ê²° ì„¤ì • (ê³µí†µ)
         */
        function setupDataConnection(conn) {
             conn.on('open', () => {
                console.log(`Data connection open with ${conn.peer}`);
                
                // í•™ìƒ -> êµì‚¬: ì—°ê²°ì´ ì—´ë¦¬ë©´, ë¯¸ë””ì–´ ì½œ(call) ìš”ì²­
                if (!isHost) {
                    console.log(`Sending media call to host ${conn.peer}`);
                    const call = peer.call(conn.peer, myStream);
                    peers[conn.peer].call = call;
                    setupMediaConnection(call);
                }
             });

             conn.on('data', (data) => {
                console.log('Received data:', data);
                // êµì‚¬ê°€ ë³´ë‚¸ ë©”ì‹œì§€ ì²˜ë¦¬
                if (data.type === 'auth_result') {
                    if (data.success) {
                        // ì¸ì¦ ì„±ê³µ
                        peers[myRoomId].username = data.username; // ë‚´ ì•„ì´ë”” ì €ì¥
                        navigate('room');
                    } else {
                        // ì¸ì¦ ì‹¤íŒ¨
                        document.getElementById('join-error').innerText = data.reason || "ì¸ì¦ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
                        peer.destroy();
                        navigate('join');
                    }
                } else if (data.type === 'peer_list') {
                    // êµì‚¬ì—ê²Œ ë°›ì€ ê¸°ì¡´ ì°¸ê°€ì ëª©ë¡
                    data.peers.forEach(p => {
                        connectToNewUser(p.id, p.username);
                    });
                } else if (data.type === 'user_connected') {
                    // ìƒˆ ì°¸ê°€ì ì•Œë¦¼
                    addChatMessage(data.username, 'ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤.', false);
                    connectToNewUser(data.peerId, data.username);
                } else if (data.type === 'user_disconnected') {
                    // ì°¸ê°€ì í‡´ì¥ ì•Œë¦¼
                    addChatMessage(peers[data.peerId]?.username || 'í‡´ì¥ì', 'ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤.', false);
                    removePeer(data.peerId);
                } else if (data.type === 'chat') {
                    // ì±„íŒ… ë©”ì‹œì§€
                    addChatMessage(data.username, data.message, false);
                    // êµì‚¬ê°€ ë¦´ë ˆì´í•œ ë©”ì‹œì§€ (í•™ìƒ -> í•™ìƒ)
                    if (isHost) {
                        relayMessage(data, conn.peer);
                    }
                }
             });

             conn.on('close', () => {
                console.log(`Data connection closed with ${conn.peer}`);
                removePeer(conn.peer);
             });
             
             conn.on('error', (err) => {
                console.error(`Data connection error with ${conn.peer}:`, err);
                removePeer(conn.peer);
             });
        }
        
        /**
         * 5. ë¯¸ë””ì–´ ì±„ë„(Call) ì—°ê²° ì„¤ì • (ê³µí†µ)
         */
        function setupMediaConnection(call) {
            call.on('stream', (remoteStream) => {
                console.log(`Received remote stream from ${call.peer}`);
                const peerId = call.peer;
                
                // ì´ë¯¸ ë¹„ë””ì˜¤ ìš”ì†Œê°€ ìˆëŠ”ì§€ í™•ì¸
                if (peers[peerId] && peers[peerId].videoEl) {
                    peers[peerId].videoEl.srcObject = remoteStream;
                    peers[peerId].videoEl.play();
                } else {
                    // ìƒˆ ë¹„ë””ì˜¤ ìš”ì†Œ ìƒì„±
                    const username = peers[peerId] ? peers[peerId].username : 'Unknown';
                    addPeerVideo(peerId, username, remoteStream);
                }
            });

            call.on('close', () => {
                console.log(`Media connection closed with ${call.peer}`);
                removePeer(call.peer);
            });

            call.on('error', (err) => {
                console.error(`Media connection error with ${call.peer}:`, err);
                removePeer(call.peer);
            });
        }

        /**
         * 6. (í•™ìƒ) ë‹¤ë¥¸ í•™ìƒì—ê²Œ ì—°ê²°
         */
         function connectToNewUser(peerId, username) {
            if (peerId === peer.id || peers[peerId]) return; // ìì‹  ë˜ëŠ” ì´ë¯¸ ì—°ê²°ëœ í”¼ì–´
            
            console.log(`Connecting to new peer: ${peerId} (${username})`);
            
            // í•™ìƒì€ ë‹¤ë¥¸ í•™ìƒê³¼ ë°ì´í„° ì±„ë„ì€ ë§Œë“¤ì§€ ì•ŠìŒ (êµì‚¬ ë¦´ë ˆì´)
            
            // *** BUG FIX: ì–‘ìª½ì—ì„œ callì„ ê±¸ì–´ ì¤‘ë³µ ì—°ê²°ë˜ëŠ” ê²ƒì„ ë°©ì§€ ***
            // ë‚´ IDê°€ ìƒëŒ€ë°© IDë³´ë‹¤ í´ ê²½ìš°ì—ë§Œ callì„ ê±´ë‹¤. (ë¬¸ìì—´ ë¹„êµ)
            if (peer.id > peerId) {
                console.log(`My ID (${peer.id}) > Peer ID (${peerId}). I will initiate call.`);
                // ë¯¸ë””ì–´ ì½œë§Œ ì‹œì‘
                const call = peer.call(peerId, myStream);
                peers[peerId] = { conn: null, call: call, username: username, videoEl: null };
                setupMediaConnection(call);
            } else {
                console.log(`My ID (${peer.id}) <= Peer ID (${peerId}). I will wait for their call.`);
                // ìƒëŒ€ë°©ì´ callì„ ê±¸ ë•Œë¥¼ ëŒ€ë¹„í•´ usernameë§Œ ì €ì¥í•´ë‘”ë‹¤.
                // 'on('call')' í•¸ë“¤ëŸ¬ê°€ call ê°ì²´ë¥¼ ì €ì¥í•  ê²ƒì„.
                peers[peerId] = { conn: null, call: null, username: username, videoEl: null };
            }
        }

        /**
         * 7. í”¼ì–´ ë¹„ë””ì˜¤ ì¶”ê°€/ì œê±°
         */
        function addPeerVideo(peerId, username, stream) {
            // ì´ë¯¸ ìˆëŠ”ì§€ ë‹¤ì‹œ í™•ì¸
            if (document.getElementById(`video-container-${peerId}`)) return;

            const container = document.createElement('div');
            container.id = `video-container-${peerId}`;
            container.className = 'video-container relative group';

            const videoEl = document.createElement('video');
            videoEl.id = `video-${peerId}`;
            videoEl.srcObject = stream;
            videoEl.playsInline = true;

            container.innerHTML = `
                <video id="video-${peerId}" playsinline></video>
                <div class="video-label">${username}</div>
                <div class="absolute top-2 right-2 space-x-1 opacity-0 group-hover:opacity-100 transition-opacity z-20">
                    <button onclick="togglePiP('video-${peerId}')" class="bg-black bg-opacity-50 p-1 rounded text-xs">PiP</button>
                    <button onclick="toggleVideoFullscreen('video-container-${peerId}')" class="bg-black bg-opacity-50 p-1 rounded text-xs">â›¶</button>
                </div>
            `;
            
            container.querySelector('video').srcObject = stream;
            videoGrid.appendChild(container);
            
            // ë¹„ë””ì˜¤ ì¬ìƒ (ì¤‘ìš”)
            container.querySelector('video').play().catch(e => console.error("Peer video play failed", e));
            
            // peers ê°ì²´ì— DOM ìš”ì†Œ ì €ì¥
            if (peers[peerId]) {
                peers[peerId].videoEl = container.querySelector('video');
            } else {
                // ì´ ê²½ìš°ëŠ” ê±°ì˜ ì—†ì§€ë§Œ, race condition ëŒ€ë¹„
                 peers[peerId] = { conn: null, call: null, username: username, videoEl: container.querySelector('video') };
            }
        }

        function removePeer(peerId) {
            if (!peers[peerId]) return;

            console.log(`Removing peer: ${peerId}`);
            
            // ì—°ê²° ì¢…ë£Œ
            if (peers[peerId].conn) peers[peerId].conn.close();
            if (peers[peerId].call) peers[peerId].call.close();
            
            // DOMì—ì„œ ë¹„ë””ì˜¤ ì œê±°
            const videoContainer = document.getElementById(`video-container-${peerId}`);
            if (videoContainer) videoContainer.remove();

            // ì¸ë„¤ì¼ì—ì„œë„ ì œê±°
             const thumbVideo = document.getElementById(`thumb-video-${peerId}`);
            if (thumbVideo) thumbVideo.remove();
            
            delete peers[peerId];
            
             // êµì‚¬ì¸ ê²½ìš° ë‹¤ë¥¸ ì‚¬ëŒë“¤ì—ê²Œ ì•Œë¦¼
            if (isHost) {
                broadcastMessage({ type: 'user_disconnected', peerId: peerId });
            } else if (peerId === myRoomId) {
                // *** IMPROVEMENT: í•™ìƒì¸ë°, ì—°ê²°ì´ ëŠê¸´ í”¼ì–´ê°€ êµì‚¬(myRoomId)ì¼ ê²½ìš° ***
                alert("êµì‚¬ê°€ ê°•ì˜ë¥¼ ì¢…ë£Œí–ˆìŠµë‹ˆë‹¤. í™ˆ í™”ë©´ìœ¼ë¡œ ì´ë™í•©ë‹ˆë‹¤.");
                // endCallBtnì˜ ë¡œì§ì„ ìˆ˜í–‰í•˜ì—¬ ëª¨ë“  ì—°ê²°ì„ ì •ë¦¬í•˜ê³  í™ˆìœ¼ë¡œ ì´ë™
                if (peer) peer.destroy();
                if (myStream) myStream.getTracks().forEach(track => track.stop());
                if (currentScreenStream) currentScreenStream.getTracks().forEach(track => track.stop());
                
                // ëª¨ë“  DOM ì •ë¦¬
                videoGrid.innerHTML = ''; // ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ ë¹„ìš°ê¸°
                addMyVideoElement(); // ë‚´ ë¹„ë””ì˜¤ë§Œ ë‹¤ì‹œ ì¶”ê°€ (ì´ˆê¸°í™”)
                chatMessages.innerHTML = ''; // ì±„íŒ… ë¹„ìš°ê¸°
                fullChatMessages.innerHTML = '';
                chatHistory.length = 0; // ê¸°ë¡ ì‚­ì œ
                
                // ìƒíƒœ ì´ˆê¸°í™”
                Object.keys(peers).forEach(key => delete peers[key]);
                isHost = false;
                myRoomId = "";
                roomPassword = "";
                studentCredentials.clear();
                isScreenSharing = false;

                navigate('home');
                window.location.reload(); // í™•ì‹¤í•œ ì´ˆê¸°í™”
            }
        }

        /**
         * 8. ë©”ì‹œì§€ ë¸Œë¡œë“œìºìŠ¤íŠ¸ (êµì‚¬ ì „ìš©)
         */
        function broadcastMessage(data) {
            if (!isHost) return;
            Object.values(peers).forEach(p => {
                if (p.conn && p.conn.open) {
                    p.conn.send(data);
                }
            });
        }
        
        /**
         * 9. ë©”ì‹œì§€ ë¦´ë ˆì´ (êµì‚¬ ì „ìš©)
         */
        function relayMessage(data, originPeerId) {
             if (!isHost) return;
            Object.values(peers).forEach(p => {
                if (p.conn && p.conn.open && p.conn.peer !== originPeerId) {
                    p.conn.send(data);
                }
            });
        }

        // --- ì»¨íŠ¸ë¡¤ ë¡œì§ ---

        // ë¹„ë””ì˜¤ í† ê¸€
        toggleVideoBtn.addEventListener('click', () => {
            const enabled = myStream.getVideoTracks()[0].enabled;
            myStream.getVideoTracks()[0].enabled = !enabled;
            toggleVideoBtn.innerHTML = !enabled ? 'ğŸ¥' : 'ğŸš«';
            toggleVideoBtn.title = !enabled ? 'ë¹„ë””ì˜¤ ë„ê¸°' : 'ë¹„ë””ì˜¤ ì¼œê¸°';
        });

        // ì˜¤ë””ì˜¤ í† ê¸€
        toggleAudioBtn.addEventListener('click', () => {
            const enabled = myStream.getAudioTracks()[0].enabled;
            myStream.getAudioTracks()[0].enabled = !enabled;
            toggleAudioBtn.innerHTML = !enabled ? 'ğŸ¤' : 'ğŸ”‡';
            toggleAudioBtn.title = !enabled ? 'ì˜¤ë””ì˜¤ ë„ê¸°' : 'ì˜¤ë””ì˜¤ ì¼œê¸°';
        });

        // í†µí™” ì¢…ë£Œ
        endCallBtn.addEventListener('click', () => {
            if (confirm("ê°•ì˜ë¥¼ ì¢…ë£Œí•˜ê³  ë‚˜ê°€ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                if (peer) peer.destroy();
                if (myStream) myStream.getTracks().forEach(track => track.stop());
                if (currentScreenStream) currentScreenStream.getTracks().forEach(track => track.stop());
                
                // ëª¨ë“  DOM ì •ë¦¬
                videoGrid.innerHTML = ''; // ë¹„ë””ì˜¤ ê·¸ë¦¬ë“œ ë¹„ìš°ê¸°
                addMyVideoElement(); // ë‚´ ë¹„ë””ì˜¤ë§Œ ë‹¤ì‹œ ì¶”ê°€ (ì´ˆê¸°í™”)
                chatMessages.innerHTML = ''; // ì±„íŒ… ë¹„ìš°ê¸°
                fullChatMessages.innerHTML = '';
                chatHistory.length = 0; // ê¸°ë¡ ì‚­ì œ
                
                // ìƒíƒœ ì´ˆê¸°í™”
                Object.keys(peers).forEach(key => delete peers[key]); // BUG FIX: .clear()ëŠ” ì¼ë°˜ ê°ì²´ì— ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.
                isHost = false;
                myRoomId = "";
                roomPassword = "";
                studentCredentials.clear();
                isScreenSharing = false;

                navigate('home');
                window.location.reload(); // ê°€ì¥ í™•ì‹¤í•œ ì´ˆê¸°í™”
            }
        });

        // í™”ë©´ ê³µìœ 
        shareScreenBtn.addEventListener('click', async () => {
            if (isScreenSharing) {
                // í™”ë©´ ê³µìœ  ì¤‘ì§€
                await stopScreenSharing();
            } else {
                // í™”ë©´ ê³µìœ  ì‹œì‘
                try {
                    currentScreenStream = await navigator.mediaDevices.getDisplayMedia({
                        video: true,
                        audio: true // ì˜¤ë””ì˜¤ ê³µìœ  ì‹œë„
                    });
                    
                    isScreenSharing = true;
                    shareScreenBtn.innerHTML = 'ğŸ–¥ï¸';
                    shareScreenBtn.title = 'í™”ë©´ ê³µìœ  ì¤‘ì§€';
                    shareScreenBtn.classList.add('bg-red-500', 'hover:bg-red-600');
                    shareScreenBtn.classList.remove('bg-green-500', 'hover:bg-green-600');

                    // ë‚´ ë¹„ë””ì˜¤ë¥¼ í™”ë©´ ê³µìœ  ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ êµì²´
                    myVideo.srcObject = currentScreenStream;

                    // ì—°ê²°ëœ ëª¨ë“  í”¼ì–´ì—ê²Œ ìŠ¤íŠ¸ë¦¼ êµì²´ ì•Œë¦¼
                    replacePeerTracks(currentScreenStream.getVideoTracks()[0]);
                    
                    // í™”ë©´ ê³µìœ  ì¤‘ì§€ ë²„íŠ¼ (ë¸Œë¼ìš°ì € ê¸°ë³¸ UI) ê°ì§€
                    currentScreenStream.getVideoTracks()[0].onended = () => {
                        stopScreenSharing();
                    };

                    // êµì‚¬ì¸ ê²½ìš° ë¦´ë ˆì´, í•™ìƒì¸ ê²½ìš° êµì‚¬ì—ê²Œ ì•Œë¦¼
                    if (!isHost) {
                        peers[myRoomId].conn.send({ type: 'screen_share', status: 'start' });
                    }

                } catch (err) {
                    console.error("Failed to share screen", err);
                }
            }
        });
        
        async function stopScreenSharing() {
            if (!currentScreenStream) return;
            
            isScreenSharing = false;
            shareScreenBtn.innerHTML = 'ğŸ–¥ï¸';
            shareScreenBtn.title = 'í™”ë©´ ê³µìœ ';
            shareScreenBtn.classList.remove('bg-red-500', 'hover:bg-red-600');
            shareScreenBtn.classList.add('bg-green-500', 'hover:bg-green-600');
            
            // ìŠ¤íŠ¸ë¦¼ ì¤‘ì§€
            currentScreenStream.getTracks().forEach(track => track.stop());
            currentScreenStream = null;

            // ë‚´ ë¹„ë””ì˜¤ë¥¼ ì›ë˜ ì¹´ë©”ë¼ë¡œ ë³µêµ¬
            myVideo.srcObject = myStream;
            
            // í”¼ì–´ë“¤ì—ê²Œ ì¹´ë©”ë¼ ìŠ¤íŠ¸ë¦¼ìœ¼ë¡œ êµì²´ ì•Œë¦¼
            replacePeerTracks(myStream.getVideoTracks()[0]);
            
            if (!isHost) {
                peers[myRoomId].conn.send({ type: 'screen_share', status: 'stop' });
            }
        }
        
        function replacePeerTracks(newTrack) {
             Object.values(peers).forEach(p => {
                if (p.call) {
                    const sender = p.call.peerConnection.getSenders().find(s => {
                        return s.track && s.track.kind === 'video';
                    });
                    if (sender) {
                        sender.replaceTrack(newTrack);
                    }
                }
            });
        }

        // --- ì±„íŒ… ë¡œì§ ---
        function addChatMessage(username, message, isMe = false) {
            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${isMe ? 'me' : 'peer'}`;
            bubble.innerHTML = `
                ${!isMe ? `<div class="font-bold text-xs mb-1">${username}</div>` : ''}
                <div>${message}</div>
            `;
            
            // ë©”ì¸ ì±„íŒ…ì°½
            chatMessages.appendChild(bubble);
            chatMessages.scrollTop = chatMessages.scrollHeight;

            // ì „ì²´í™”ë©´ ì±„íŒ…ì°½
            const bubbleClone = bubble.cloneNode(true);
            fullChatMessages.appendChild(bubbleClone);
            fullChatMessages.scrollTop = fullChatMessages.scrollHeight;

            // íˆìŠ¤í† ë¦¬ ì €ì¥
            chatHistory.push({ username, message, timestamp: new Date() });
        }

        function handleChatSubmit(e) {
            e.preventDefault();
            let inputField;
            
            if (e.target.id === 'chat-form') {
                inputField = chatInput;
            } else {
                inputField = chatInputFull;
            }
            
            const message = inputField.value.trim();
            if (!message) return;

            const myUsername = isHost ? 'êµì‚¬' : (peers[myRoomId]?.username || 'ë‚˜');
            
            // 1. ë‚´ í™”ë©´ì— ì¶”ê°€
            addChatMessage(myUsername, message, true);
            
            // 2. ìƒëŒ€ë°©ì—ê²Œ ì „ì†¡
            const data = { type: 'chat', username: myUsername, message: message };
            if (isHost) {
                broadcastMessage(data); // êµì‚¬ëŠ” ëª¨ë‘ì—ê²Œ
            } else if (peers[myRoomId] && peers[myRoomId].conn) {
                peers[myRoomId].conn.send(data); // í•™ìƒì€ êµì‚¬ì—ê²Œ
            }

            // ì…ë ¥ì°½ ë¹„ìš°ê¸°
            chatInput.value = '';
            chatInputFull.value = '';
        }

        chatForm.addEventListener('submit', handleChatSubmit);
        chatFormFull.addEventListener('submit', handleChatSubmit);

        // ì±„íŒ… ìƒˆ ì°½ (ëª¨ë°”ì¼ìš©) í† ê¸€
        toggleChatNewWindowBtn.addEventListener('click', () => {
            chatWrapper.classList.toggle('hidden'); // ë°ìŠ¤í¬íƒ‘ì—ì„œëŠ” ìˆ¨ê¹€/í‘œì‹œ
            fullChatView.classList.toggle('hidden'); // ëª¨ë°”ì¼ì—ì„œëŠ” ì „ì²´í™”ë©´/ìˆ¨ê¹€
        });
        
        // ì „ì²´ ì±„íŒ…ì°½ ë‹«ê¸° ë²„íŠ¼
        closeFullChatBtn.addEventListener('click', () => {
             fullChatView.classList.add('hidden');
             chatWrapper.classList.remove('hidden'); // ë°ìŠ¤í¬íƒ‘ ë ˆì´ì•„ì›ƒ ë³µêµ¬
        });

        // CSV ë‚´ë³´ë‚´ê¸°
        exportChatBtn.addEventListener('click', () => {
            if (chatHistory.length === 0) {
                alert("ì €ì¥í•  ì±„íŒ… ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Timestamp,Username,Message\r\n"; // í—¤ë”

            chatHistory.forEach(row => {
                const timestamp = row.timestamp.toLocaleString('ko-KR');
                const username = `"${row.username.replace(/"/g, '""')}"`;
                const message = `"${row.message.replace(/"/g, '""')}"`;
                csvContent += [timestamp, username, message].join(",") + "\r\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `ezlive_chat_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });


        // --- ë¹„ë””ì˜¤ ì»¨íŠ¸ë¡¤ (PiP, Fullscreen) ---
        
        // PiP (Picture-in-Picture)
        async function togglePiP(videoId) {
            const videoEl = document.getElementById(videoId);
            if (!videoEl) return;
            
            if (document.pictureInPictureElement === videoEl) {
                await document.exitPictureInPicture();
            } else {
                try {
                    await videoEl.requestPictureInPicture();
                } catch (err) {
                    console.error("PiP failed:", err);
                }
            }
        }

        // ì „ì²´í™”ë©´
        let currentFullscreenElement = null;
        function toggleVideoFullscreen(containerId) {
            const containerEl = document.getElementById(containerId);
            if (!containerEl) return;

            if (document.fullscreenElement === containerEl) {
                // ì „ì²´í™”ë©´ ì¢…ë£Œ
                document.exitFullscreen();
                currentFullscreenElement = null;
                thumbnailVideos.style.display = 'none'; // ì¸ë„¤ì¼ ìˆ¨ê¸°ê¸°
                thumbnailVideos.innerHTML = ''; // ì¸ë„¤ì¼ ë¹„ìš°ê¸°
            } else {
                // ì „ì²´í™”ë©´ ì‹œì‘
                containerEl.requestFullscreen().then(() => {
                    currentFullscreenElement = containerEl;
                    // ë‹¤ë¥¸ ë¹„ë””ì˜¤ë“¤ì„ ì¸ë„¤ì¼ë¡œ ë§Œë“¤ê¸°
                    updateThumbnailVideos(containerId);
                });
            }
        }
        
        // ì „ì²´í™”ë©´ ì‹œ ì¸ë„¤ì¼ ì—…ë°ì´íŠ¸
        function updateThumbnailVideos(mainContainerId) {
            thumbnailVideos.innerHTML = ''; // ë¹„ìš°ê¸°
            const allVideos = videoGrid.querySelectorAll('.video-container');
            
            allVideos.forEach(container => {
                if (container.id !== mainContainerId) {
                    const clone = container.cloneNode(true); // ë¹„ë””ì˜¤ ì»¨í…Œì´ë„ˆ ë³µì œ
                    clone.id = `thumb-${container.id}`;
                    
                    // ë³µì œëœ ë¹„ë””ì˜¤ê°€ ì›ë³¸ ìŠ¤íŠ¸ë¦¼ì„ ê°–ë„ë¡ í•¨
                    const originalVideoId = container.querySelector('video').id;
                    const originalVideo = document.getElementById(originalVideoId);
                    const thumbVideo = clone.querySelector('video');
                    thumbVideo.srcObject = originalVideo.srcObject;
                    thumbVideo.muted = true; // ì¸ë„¤ì¼ì€ ìŒì†Œê±°
                    thumbVideo.play().catch(e => {});

                    // ì¸ë„¤ì¼ í´ë¦­ ì‹œ ì „ì²´í™”ë©´ êµì²´
                    clone.onclick = () => {
                        document.exitFullscreen().then(() => {
                             toggleVideoFullscreen(container.id);
                        });
                    };
                    thumbnailVideos.appendChild(clone);
                }
            });
            thumbnailVideos.style.display = 'block';
        }

        // ì „ì²´í™”ë©´ ë³€ê²½ ì‹œ ì¸ë„¤ì¼ ìƒíƒœ ê´€ë¦¬
        document.addEventListener('fullscreenchange', () => {
            if (!document.fullscreenElement) {
                // ì „ì²´í™”ë©´ì´ ì¢…ë£Œë˜ì—ˆì„ ë•Œ
                currentFullscreenElement = null;
                thumbnailVideos.style.display = 'none';
                thumbnailVideos.innerHTML = '';
            }
        });

        // --- í˜ì´ì§€ë³„ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ---

        // 1. êµì‚¬: ê°•ì˜ ìƒì„±
        createRoomBtn.addEventListener('click', async () => {
            const teacherPass = document.getElementById('teacher-pass').value;
            const roomName = document.getElementById('room-name').value;
            const studentPass = document.getElementById('room-pass').value;
            const studentListText = document.getElementById('student-list').value;
            const errorEl = document.getElementById('create-error');

            // 1.1. êµì‚¬ ë¹„ë²ˆ í™•ì¸
            if (teacherPass !== 'a123456!') {
                errorEl.innerText = "êµì‚¬ ì¸ì¦ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                return;
            }
            
            // 1.2. ìœ íš¨ì„± ê²€ì‚¬
            if (!roomName || !studentPass || !studentListText) {
                errorEl.innerText = "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                return;
            }

            // 1.3. í•™ìƒ ëª©ë¡ íŒŒì‹±
            studentCredentials.clear();
            try {
                studentListText.split('\n').forEach(line => {
                    line = line.trim();
                    if (line) {
                        const [id, pass] = line.split(',').map(s => s.trim());
                        if (id && pass) {
                            studentCredentials.set(id, pass);
                        } else {
                            throw new Error(`ì˜ëª»ëœ í•™ìƒ ì •ë³´ í˜•ì‹: ${line}`);
                        }
                    }
                });
                if (studentCredentials.size === 0) {
                     throw new Error("ìµœì†Œ í•œ ëª…ì˜ í•™ìƒì„ ë“±ë¡í•´ì•¼ í•©ë‹ˆë‹¤.");
                }
            } catch (e) {
                errorEl.innerText = e.message;
                return;
            }

            // 1.4. ìƒíƒœ ì„¤ì • ë° ë¯¸ë””ì–´ ì¤€ë¹„
            isHost = true;
            roomPassword = studentPass;
            myRoomId = roomName; // êµì‚¬ëŠ” ë°© ì´ë¦„ì„ IDë¡œ ì‚¬ìš©
            errorEl.innerText = "";

            await getMediaStream();
            if (!myStream) {
                 errorEl.innerText = "ì¹´ë©”ë¼/ë§ˆì´í¬ ì ‘ê·¼ì´ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.";
                 return;
            }
            
            // 1.5. Peer ì´ˆê¸°í™” ë° ë°© ì…ì¥
            initializePeer(myRoomId);
            navigate('room');
        });

        // 2. í•™ìƒ: ê°•ì˜ ì°¸ì—¬
        joinRoomBtn.addEventListener('click', async () => {
            const roomId = document.getElementById('join-room-id').value;
            const roomPass = document.getElementById('join-room-pass').value;
            const studentId = document.getElementById('join-student-id').value;
            const studentPass = document.getElementById('join-student-pass').value;
            const errorEl = document.getElementById('join-error');
            
            if (!roomId || !roomPass || !studentId || !studentPass) {
                errorEl.innerText = "ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.";
                return;
            }

            errorEl.innerText = "ì—°ê²° ì¤‘...";
            isHost = false;
            myRoomId = roomId; // ì—°ê²°í•  í˜¸ìŠ¤íŠ¸ ID

            // 2.1. Peer ì´ˆê¸°í™” (ëœë¤ ID)
            initializePeer(); 
            
            // 2.2. í˜¸ìŠ¤íŠ¸ì—ê²Œ ì—°ê²° ì‹œë„ (ì¸ì¦ í¬í•¨)
            // Peer 'open' ì´ë²¤íŠ¸ë¥¼ ê¸°ë‹¤ë ¤ì•¼ í•¨
            peer.on('open', () => {
                 connectToHost(roomId, roomPass, studentId, studentPass);
            });
        });
        
        // --- ìœ í‹¸ë¦¬í‹° ---
        
        // ê°•ì˜ ì •ë³´ ë³µì‚¬
        function copyRoomInfo() {
            const text = `ezlive ê°•ì˜ì‹¤ ì •ë³´\n- ê°•ì˜ì‹¤ ì´ë¦„(ID): ${myRoomId}\n- ì ‘ì† ë¹„ë°€ë²ˆí˜¸: ${roomPassword}`;
            
            if (navigator.clipboard) {
                navigator.clipboard.writeText(text).then(() => {
                    alert("ê°•ì˜ì‹¤ ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                }).catch(err => {
                    alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                });
            } else {
                // êµ¬í˜• ë¸Œë¼ìš°ì €/ë³´ì•ˆ(http) ì´ìŠˆ í´ë°±
                const textArea = document.createElement("textarea");
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.focus();
                textArea.select();
                try {
                    document.execCommand('copy');
                    alert("ê°•ì˜ì‹¤ ì •ë³´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.");
                } catch (err) {
                    alert("ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
                }
                document.body.removeChild(textArea);
            }
        }
        
        // ë‚´ ë¹„ë””ì˜¤ ìš”ì†Œ ì¶”ê°€ (ì´ˆê¸°í™”ìš©)
        function addMyVideoElement() {
            videoGrid.insertAdjacentHTML('afterbegin', `
                <div id="my-video-container" class="video-container relative group">
                    <video id="my-video" muted playsinline></video>
                    <div class="video-label">ë‚˜</div>
                    <div class="absolute top-2 right-2 space-x-1 opacity-0 group-hover:opacity-100 transition-opacity z-20">
                        <button onclick="togglePiP('my-video')" class="bg-black bg-opacity-50 p-1 rounded text-xs">PiP</button>
                        <button onclick="toggleVideoFullscreen('my-video-container')" class="bg-black bg-opacity-50 p-1 rounded text-xs">â›¶</button>
                    </div>
                </div>
            `);
            myVideo = document.getElementById('my-video');
        }

    </script>

</body>
</html>
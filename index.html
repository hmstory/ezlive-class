<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ezlive - ì •ë‹µ í™•ì¸ìš©</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: "Pretendard", sans-serif; background-color: #000; color: white; overflow: hidden; }
        .page { display: none; }
        .page.active { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: 100vh; }
        
        #video-grid { 
            display: grid; 
            grid-template-columns: 1fr 1fr; 
            gap: 10px; 
            width: 100%; 
            height: 100vh; 
            padding: 10px;
            background: #000;
        }

        @media (max-width: 768px) {
            #video-grid { grid-template-columns: 1fr; grid-template-rows: 1fr 1fr; }
        }
        
        .video-container { 
            position: relative; 
            width: 100%; 
            height: 100%; 
            background: #222; 
            border-radius: 12px; 
            overflow: hidden; 
            border: 1px solid #444;
        }
        
        video { 
            width: 100%; 
            height: 100%; 
            object-fit: cover; 
        }
        
        .my-video { transform: scaleX(-1); }

        /* ì—°ê²° ìƒíƒœ ë¡œê·¸ì°½ */
        .status-log {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
            font-size: 0.9rem;
            z-index: 50;
            border: 1px solid #666;
            white-space: pre-line;
        }

        .badge {
            display: inline-block;
            background-color: #dc2626; /* ë¹¨ê°„ìƒ‰ */
            color: white;
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>

    <!-- 1. í™ˆ í™”ë©´ -->
    <div id="page-home" class="page active bg-gray-900">
        <div class="bg-gray-800 p-8 rounded-2xl text-center max-w-sm w-full border border-gray-700">
            <h1 class="text-4xl font-bold text-white mb-4">ezlive</h1>
            <span class="badge">ğŸ”¥ ë²„ì „ 13 (ì§„ë‹¨ ëª¨ë“œ)</span>
            
            <div class="space-y-4 mt-4">
                <button onclick="goPage('create')" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg">
                    ğŸ‘¨â€ğŸ« ë°© ë§Œë“¤ê¸°
                </button>
                <button onclick="goPage('join')" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg">
                    ğŸ‘¨â€ğŸ“ ì…ì¥í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- 2. ìƒì„±/ì…ì¥ UI -->
    <div id="page-create" class="page bg-gray-900">
        <div class="bg-gray-800 p-8 rounded-2xl text-center max-w-sm w-full border border-gray-700">
            <h2 class="text-2xl font-bold mb-4">ë°© ì´ë¦„</h2>
            <input type="text" id="create-name" placeholder="ì˜ˆ: math" class="w-full bg-gray-700 border border-gray-600 p-4 mb-4 rounded-xl text-white text-lg text-center">
            <button onclick="startHosting()" class="w-full bg-blue-600 text-white py-4 rounded-xl font-bold text-lg">ì‹œì‘</button>
            <button onclick="goPage('home')" class="mt-4 text-gray-400 underline">ë’¤ë¡œê°€ê¸°</button>
        </div>
    </div>

    <div id="page-join" class="page bg-gray-900">
        <div class="bg-gray-800 p-8 rounded-2xl text-center max-w-sm w-full border border-gray-700">
            <h2 class="text-2xl font-bold mb-4">ë°© ì´ë¦„</h2>
            <input type="text" id="join-name" placeholder="ì„ ìƒë‹˜ì´ ë§Œë“  ë°© ì´ë¦„" class="w-full bg-gray-700 border border-gray-600 p-4 mb-4 rounded-xl text-white text-lg text-center">
            <button onclick="joinSession()" class="w-full bg-green-600 text-white py-4 rounded-xl font-bold text-lg">ì…ì¥</button>
            <button onclick="goPage('home')" class="mt-4 text-gray-400 underline">ë’¤ë¡œê°€ê¸°</button>
        </div>
    </div>

    <!-- 3. ê°•ì˜ì‹¤ -->
    <div id="page-room" class="page hidden">
        <div id="video-grid"></div>
        <div style="position: fixed; bottom: 20px; left: 20px; background: black; padding: 5px; font-size: 10px; opacity: 0.5;">
            ID: <span id="my-id-display">...</span>
        </div>
    </div>

    <script>
        const pages = ['home', 'create', 'join', 'room'];
        function goPage(target) {
            pages.forEach(p => {
                document.getElementById(`page-${p}`).classList.remove('active');
                if(p === 'room') document.getElementById(`page-${p}`).classList.add('hidden');
            });
            const t = document.getElementById(`page-${target}`);
            t.classList.add('active');
            t.classList.remove('hidden');
        }

        let peer;
        let myStream;

        // [í•µì‹¬] ìµœì‹  í‘œì¤€(Unified Plan) ì ìš© ë° STUN ì„œë²„
        const peerConfig = {
            debug: 2,
            sdpSemantics: 'unified-plan', // [ì¤‘ìš”] ìµœì‹  ë¸Œë¼ìš°ì € í˜¸í™˜ì„± í•´ê²°
            config: {
                'iceServers': [
                    { url: 'stun:stun.l.google.com:19302' },
                    { url: 'stun:stun1.l.google.com:19302' },
                    { url: 'stun:stun2.l.google.com:19302' },
                    { url: 'stun:global.stun.twilio.com:3478' }
                ]
            }
        };

        async function initMedia() {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'user' }, audio: true });
                addVideo(myStream, true, 'my-video');
                goPage('room');
                return true;
            } catch(e) {
                alert("ì¹´ë©”ë¼ ê¶Œí•œ ì˜¤ë¥˜: " + e);
                return false;
            }
        }

        async function startHosting() {
            const roomName = document.getElementById('create-name').value.trim();
            if(!roomName) return;
            if(await initMedia()) {
                peer = new Peer(roomName, peerConfig);
                
                peer.on('open', id => document.getElementById('my-id-display').innerText = id);
                
                peer.on('call', call => {
                    call.answer(myStream);
                    setupCallEvents(call, false);
                });
            }
        }

        async function joinSession() {
            const roomName = document.getElementById('join-name').value.trim();
            if(!roomName) return;
            if(await initMedia()) {
                peer = new Peer(null, peerConfig);
                
                peer.on('open', id => {
                    document.getElementById('my-id-display').innerText = id;
                    const call = peer.call(roomName, myStream);
                    setupCallEvents(call, true);
                });
                
                peer.on('error', err => alert("ì˜¤ë¥˜: " + err.type));
            }
        }

        // [ì¤‘ìš”] ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§ ë° ì´ë²¤íŠ¸ ì²˜ë¦¬
        function setupCallEvents(call, isInitiator) {
            call.on('stream', stream => {
                addVideo(stream, false, 'peer-video', call);
            });
            
            call.on('close', () => {
                alert("ìƒëŒ€ë°© ì—°ê²°ì´ ëŠê²¼ìŠµë‹ˆë‹¤.");
                const el = document.getElementById('peer-video');
                if(el) el.remove();
            });
            
            call.on('error', err => console.error(err));
        }

        function addVideo(stream, isMe, videoId, call) {
            const existing = document.getElementById(videoId);
            if(existing) existing.remove();

            const wrapper = document.createElement('div');
            wrapper.id = videoId;
            wrapper.className = 'video-container';
            
            const video = document.createElement('video');
            video.srcObject = stream;
            video.setAttribute('playsinline', ''); 
            video.setAttribute('webkit-playsinline', '');
            video.autoplay = true;
            
            // ì†Œë¦¬ ì„¤ì •: ë‚˜ëŠ” ë„ê³ , ìƒëŒ€ëŠ” ì¼œê³ 
            if(isMe) {
                video.muted = true;
                video.classList.add('my-video');
            } else {
                video.muted = false; // ìƒëŒ€ë°© ì†Œë¦¬ ì¼œê¸°
                
                // [ì§„ë‹¨ìš©] ì—°ê²° ìƒíƒœ ë¡œê·¸ì°½
                const log = document.createElement('div');
                log.className = 'status-log';
                log.innerText = "ì—°ê²° ì‹œë„ ì¤‘...\n(ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”)";
                wrapper.appendChild(log);

                // 1. ë©”íƒ€ë°ì´í„° ë¡œë“œ í™•ì¸
                video.onloadedmetadata = () => {
                    log.innerText = "ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ!\nì¬ìƒ ì¤‘...";
                    video.play().then(() => {
                        setTimeout(() => log.style.display = 'none', 1000);
                    }).catch(e => {
                        log.innerText = "í™”ë©´ì„ í„°ì¹˜í•˜ì„¸ìš”!";
                        log.onclick = () => {
                            video.play();
                            log.style.display = 'none';
                        }
                    });
                };

                // 2. ICE ì—°ê²° ìƒíƒœ ëª¨ë‹ˆí„°ë§ (ë°©í™”ë²½ í™•ì¸ìš©)
                if(call && call.peerConnection) {
                    call.peerConnection.oniceconnectionstatechange = () => {
                        const state = call.peerConnection.iceConnectionState;
                        console.log("ICE State:", state);
                        if(state === 'failed' || state === 'disconnected') {
                            log.style.display = 'block';
                            log.style.background = 'rgba(255,0,0,0.8)';
                            log.innerText = "ì—°ê²° ì‹¤íŒ¨!\n(ë°©í™”ë²½ì´ ë§‰ê³  ìˆìŠµë‹ˆë‹¤)\nLTEë‚˜ í•«ìŠ¤íŒŸì„ ì¨ë³´ì„¸ìš”.";
                        } else if(state === 'connected' || state === 'completed') {
                            // ì—°ê²° ì„±ê³µí•˜ë©´ ë¡œê·¸ ìˆ¨ê¸°ê¸° ì‹œë„
                            if(video.readyState >= 3) log.style.display = 'none';
                        }
                    };
                }
            }
            
            wrapper.appendChild(video);
            document.getElementById('video-grid').appendChild(wrapper);
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ezlive - P2P í™”ìƒ ê°•ì˜</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PeerJS CDN -->
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        body { font-family: "Inter", "Pretendard", sans-serif; }
        #video-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 1rem; }
        .video-container { position: relative; width: 100%; padding-bottom: 100%; border-radius: 0.5rem; overflow: hidden; background-color: #2d3748; }
        .video-container video { position: absolute; top: 0; left: 0; width: 100%; height: 100%; object-fit: cover; }
        .video-container .video-label { position: absolute; bottom: 8px; left: 8px; background-color: rgba(0, 0, 0, 0.5); color: white; padding: 2px 6px; border-radius: 4px; font-size: 0.875rem; }
        .chat-bubble { max-width: 70%; padding: 8px 12px; border-radius: 1rem; }
        .chat-bubble.me { background-color: #3b82f6; color: white; align-self: flex-end; border-bottom-right-radius: 0.25rem; }
        .chat-bubble.peer { background-color: #e5e7eb; color: #1f2937; align-self: flex-start; border-bottom-left-radius: 0.25rem; }
        .page { display: none; }
        .page.active { display: block; }
        #thumbnail-videos { position: fixed; top: 20px; left: 20px; width: 150px; z-index: 1001; display: none; }
        #thumbnail-videos .video-container { padding-bottom: 100%; margin-bottom: 8px; }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <!-- ê²½ê³  ë©”ì‹œì§€ -->
    <div id="security-warning" class="hidden p-4 bg-red-600 text-white font-bold text-center">
        ê²½ê³ : ì¹´ë©”ë¼ì™€ ë§ˆì´í¬ëŠ” 'https://' í™˜ê²½ì—ì„œë§Œ ì‘ë™í•©ë‹ˆë‹¤. í˜„ì¬ ë³´ì•ˆë˜ì§€ ì•Šì€ í™˜ê²½ì…ë‹ˆë‹¤.
    </div>

    <!-- í˜ì´ì§€: í™ˆ -->
    <div id="page-home" class="page active min-h-screen flex items-center justify-center">
        <div class="text-center p-8 bg-white rounded-lg shadow-xl">
            <h1 class="text-4xl font-bold mb-8 text-blue-600">ezlive</h1>
            <div class="space-y-4">
                <button onclick="navigate('create')" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700 transition">
                    êµì‚¬ìš© í™”ìƒê°•ì˜ ìƒì„±
                </button>
                <button onclick="navigate('join')" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-green-700 transition">
                    í•™ìƒìš© ê°•ì˜ ì°¸ì—¬
                </button>
            </div>
        </div>
    </div>

    <!-- í˜ì´ì§€: êµì‚¬ìš© ê°•ì˜ ìƒì„± -->
    <div id="page-create" class="page min-h-screen flex items-center justify-center bg-gray-50">
        <div class="p-8 bg-white rounded-lg shadow-xl w-full max-w-md">
            <button onclick="navigate('home')" class="text-gray-500 hover:text-gray-700">&larr; ë’¤ë¡œê°€ê¸°</button>
            <h2 class="text-2xl font-bold text-center my-4">êµì‚¬ìš© ê°•ì˜ ìƒì„±</h2>
            <div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">êµì‚¬ ì¸ì¦ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="teacher-pass" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="a123456!"></div>
                <div><label class="block text-sm font-medium text-gray-700">ê°•ì˜ì‹¤ ì´ë¦„</label><input type="text" id="room-name" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="ì˜ˆ: math101"></div>
                <div><label class="block text-sm font-medium text-gray-700">í•™ìƒ ì ‘ì† ë¹„ë°€ë²ˆí˜¸</label><input type="text" id="room-pass" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="í•™ìƒìš© ë¹„ë²ˆ"></div>
                <div><label class="block text-sm font-medium text-gray-700">í•™ìƒ ëª…ë‹¨ (ì•„ì´ë””,ë¹„ë²ˆ)</label><textarea id="student-list" rows="5" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md" placeholder="user1,1234&#10;user2,5678"></textarea></div>
                <button id="create-room-btn" class="w-full bg-blue-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-blue-700">ê°•ì˜ ìƒì„± ë° ì‹œì‘</button>
                <div id="create-error" class="text-red-500 text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- í˜ì´ì§€: í•™ìƒìš© ê°•ì˜ ì°¸ì—¬ -->
    <div id="page-join" class="page min-h-screen flex items-center justify-center bg-gray-50">
        <div class="p-8 bg-white rounded-lg shadow-xl w-full max-w-md">
            <button onclick="navigate('home')" class="text-gray-500 hover:text-gray-700">&larr; ë’¤ë¡œê°€ê¸°</button>
            <h2 class="text-2xl font-bold text-center my-4">í•™ìƒìš© ê°•ì˜ ì°¸ì—¬</h2>
            <div class="space-y-4">
                <div><label class="block text-sm font-medium text-gray-700">ê°•ì˜ì‹¤ ì´ë¦„</label><input type="text" id="join-room-id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label class="block text-sm font-medium text-gray-700">ê°•ì˜ì‹¤ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="join-room-pass" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label class="block text-sm font-medium text-gray-700">ë‚´ ì•„ì´ë””</label><input type="text" id="join-student-id" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label class="block text-sm font-medium text-gray-700">ë‚´ ë¹„ë°€ë²ˆí˜¸</label><input type="password" id="join-student-pass" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <button id="join-room-btn" class="w-full bg-green-600 text-white px-6 py-3 rounded-lg text-lg font-semibold hover:bg-green-700">ê°•ì˜ ì°¸ì—¬í•˜ê¸°</button>
                <div id="join-error" class="text-red-500 text-sm text-center"></div>
            </div>
        </div>
    </div>

    <!-- í˜ì´ì§€: ê°•ì˜ì‹¤ -->
    <div id="page-room" class="page h-screen flex flex-col md:flex-row bg-gray-900 text-white">
        <div class="flex-1 flex flex-col h-full overflow-hidden relative">
            <div class="absolute top-0 left-0 p-2 space-x-2 z-10 bg-gray-900 bg-opacity-50 rounded-br-lg">
                <button id="toggle-video-btn" class="bg-blue-500 p-2 rounded-full">ğŸ¥</button>
                <button id="toggle-audio-btn" class="bg-blue-500 p-2 rounded-full">ğŸ¤</button>
                <button id="share-screen-btn" class="bg-green-500 p-2 rounded-full">ğŸ–¥ï¸</button>
                <button id="export-chat-btn" class="bg-gray-500 p-2 rounded-full">ğŸ’¾</button>
                <button id="end-call-btn" class="bg-red-500 p-2 rounded-full">ğŸšª</button>
            </div>
            <div id="room-info" class="hidden absolute top-0 right-0 p-3 bg-gray-800 text-sm rounded-bl-lg z-10">
                ID: <strong id="info-room-id" class="text-yellow-300"></strong> / PW: <strong id="info-room-pass" class="text-yellow-300"></strong>
            </div>
            <div id="thumbnail-videos" class="space-y-2"></div>
            <div id="video-grid" class="flex-1 p-4 pt-16 overflow-y-auto"></div>
            
            <div id="chat-wrapper" class="h-1/3 md:h-full md:w-80 bg-gray-800 flex flex-col flex-shrink-0 transition-all">
                <h3 class="text-lg font-semibold p-3 border-b border-gray-700">ì±„íŒ…</h3>
                <div id="chat-messages" class="flex-1 p-3 space-y-2 overflow-y-auto flex flex-col"></div>
                <div class="p-3 border-t border-gray-700">
                    <form id="chat-form" class="flex space-x-2">
                        <input id="chat-input" type="text" class="flex-1 bg-gray-700 text-white rounded-lg px-4 py-2" placeholder="ë©”ì‹œì§€..." autocomplete="off">
                        <button type="submit" class="bg-blue-600 px-4 py-2 rounded-lg">ì „ì†¡</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- ì „ì—­ ë³€ìˆ˜ ---
        let peer, myStream, isHost = false, myRoomId = "", roomPassword = "", isScreenSharing = false, currentScreenStream;
        const peers = {}, chatHistory = [], studentCredentials = new Map();
        
        // --- í˜ì´ì§€ ìš”ì†Œ ---
        const pages = { home: document.getElementById('page-home'), create: document.getElementById('page-create'), join: document.getElementById('page-join'), room: document.getElementById('page-room') };
        const videoGrid = document.getElementById('video-grid');
        
        // --- ë„¤ë¹„ê²Œì´ì…˜ í•¨ìˆ˜ ---
        function navigate(pageName) {
            Object.values(pages).forEach(p => p.classList.remove('active'));
            pages[pageName].classList.add('active');
        }

        // --- 1. ë¯¸ë””ì–´ ìŠ¤íŠ¸ë¦¼ (ì¹´ë©”ë¼/ë§ˆì´í¬) ---
        async function getMediaStream() {
            try {
                myStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
                addMyVideo(myStream);
            } catch (err) {
                console.error(err);
                alert("ì¹´ë©”ë¼/ë§ˆì´í¬ ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤.");
            }
        }

        function addMyVideo(stream) {
            if(document.getElementById('my-video')) return;
            const div = document.createElement('div');
            div.className = 'video-container';
            div.innerHTML = `<video id="my-video" muted playsinline></video><div class="video-label">ë‚˜</div>`;
            videoGrid.prepend(div);
            const v = div.querySelector('video');
            v.srcObject = stream;
            v.play();
        }

        // --- 2. PeerJS ì´ˆê¸°í™” (í•µì‹¬) ---
        function initializePeer(id) {
            peer = id ? new Peer(id) : new Peer();
            
            peer.on('open', (peerId) => {
                console.log('My ID:', peerId);
                if(isHost) {
                    myRoomId = peerId;
                    document.getElementById('info-room-id').innerText = peerId;
                    document.getElementById('info-room-pass').innerText = roomPassword;
                    document.getElementById('room-info').classList.remove('hidden');
                } else {
                    // í•™ìƒ: ID ìƒì„± í›„ í˜¸ìŠ¤íŠ¸ ì—°ê²° ì‹œë„
                    const roomId = document.getElementById('join-room-id').value;
                    const roomPass = document.getElementById('join-room-pass').value;
                    const sId = document.getElementById('join-student-id').value;
                    const sPass = document.getElementById('join-student-pass').value;
                    connectToHost(roomId, roomPass, sId, sPass);
                }
            });

            peer.on('error', (err) => {
                alert("ì—°ê²° ì˜¤ë¥˜: " + err.type);
                navigate('home');
            });

            // ë°ì´í„° ì—°ê²° ìˆ˜ì‹  (ì±„íŒ… ë“±)
            peer.on('connection', (conn) => {
                conn.on('data', data => handleData(data, conn));
                conn.on('open', () => {
                    // êµì‚¬ -> í•™ìƒ: ì…ì¥ ì‹œ ëª…ë‹¨/í™˜ì˜ ë©”ì‹œì§€ ì „ì†¡ ê°€ëŠ¥
                });
            });

            // ë¯¸ë””ì–´ ì—°ê²° ìˆ˜ì‹  (í™”ìƒ)
            peer.on('call', (call) => {
                call.answer(myStream); // ë‚´ í™”ë©´ ë³´ë‚´ë©° ì‘ë‹µ
                call.on('stream', userStream => {
                    addPeerVideo(call.peer, userStream);
                });
            });
        }

        // --- 3. ì—°ê²° ë° ë°ì´í„° ì²˜ë¦¬ ---
        function connectToHost(hostId, rPass, sId, sPass) {
            const conn = peer.connect(hostId, { metadata: { rPass, sId, sPass } });
            conn.on('open', () => {
                console.log("Connected to Host");
                // ë¯¸ë””ì–´ ì½œ ìš”ì²­
                const call = peer.call(hostId, myStream);
                call.on('stream', hostStream => addPeerVideo(hostId, hostStream));
            });
            conn.on('data', data => handleData(data, conn));
            conn.on('close', () => alert("ì—°ê²°ì´ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤."));
        }

        function handleData(data, conn) {
            if(data.type === 'chat') {
                addChatBubble(data.sender, data.msg, false);
            } else if(data.type === 'auth_fail') {
                alert("ì¸ì¦ ì‹¤íŒ¨: " + data.reason);
                navigate('home');
            }
        }

        function addPeerVideo(id, stream) {
            if(document.getElementById('vid-'+id)) return;
            const div = document.createElement('div');
            div.className = 'video-container';
            div.innerHTML = `<video id="vid-${id}" playsinline></video><div class="video-label">${id}</div>`;
            videoGrid.appendChild(div);
            const v = div.querySelector('video');
            v.srcObject = stream;
            v.play();
        }

        // --- 4. ì±„íŒ… ---
        document.getElementById('chat-form').addEventListener('submit', (e) => {
            e.preventDefault();
            const input = document.getElementById('chat-input');
            const msg = input.value;
            if(!msg) return;
            
            addChatBubble("ë‚˜", msg, true);
            // ì „ì†¡ (ëª¨ë“  í”¼ì–´ì—ê²Œ)
            // ì‹¤ì œ êµ¬í˜„ì‹œì—” ì—°ê²°ëœ conn ë¦¬ìŠ¤íŠ¸ë¥¼ ê´€ë¦¬í•´ì„œ ë³´ë‚´ì•¼ í•¨. (ê°„ì†Œí™”ë¨)
            
            input.value = '';
        });

        function addChatBubble(sender, msg, isMe) {
            const div = document.createElement('div');
            div.className = `chat-bubble ${isMe ? 'me' : 'peer'}`;
            div.innerText = isMe ? msg : `${sender}: ${msg}`;
            document.getElementById('chat-messages').appendChild(div);
        }

        // --- 5. ë²„íŠ¼ ì´ë²¤íŠ¸ ---
        document.getElementById('create-room-btn').addEventListener('click', async () => {
            const tPass = document.getElementById('teacher-pass').value;
            const rName = document.getElementById('room-name').value;
            const rPass = document.getElementById('room-pass').value;
            
            if(tPass !== 'a123456!') return alert("êµì‚¬ ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜");
            if(!rName || !rPass) return alert("ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”");
            
            isHost = true;
            roomPassword = rPass;
            // í•™ìƒ ëª…ë‹¨ íŒŒì‹±ì€ ìƒëµ (ê°„ì†Œí™”)
            
            await getMediaStream();
            if(myStream) {
                initializePeer(rName);
                navigate('room');
            }
        });

        document.getElementById('join-room-btn').addEventListener('click', async () => {
            const rId = document.getElementById('join-room-id').value;
            if(!rId) return alert("ê°•ì˜ì‹¤ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”");
            
            await getMediaStream();
            if(myStream) {
                initializePeer(); // ëœë¤ IDë¡œ ì‹œì‘ -> open ì´ë²¤íŠ¸ì—ì„œ connectToHost í˜¸ì¶œ
                navigate('room');
            }
        });
        
        // ì´ˆê¸° ê²½ê³  í™•ì¸
        if(location.protocol !== 'https:' && location.hostname !== 'localhost') {
            document.getElementById('security-warning').classList.remove('hidden');
        }
    </script>
</body>
</html>